<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
    <!-- Define product details -->
    <Product 
        Id="*" 
        Name="ZLT System Monitor" 
        Language="1033" 
        Version="1.0.0.0" 
        Manufacturer="ZLT" 
        UpgradeCode="3a26de72-ebee-4375-b0d6-65f42e37c647">
        
        <Package 
            InstallerVersion="200" 
            Compressed="yes" 
            InstallScope="perMachine" 
            Description="System Monitoring Dashboard" 
            Comments="ZLT System Monitor with Memory Optimization" />

        <MajorUpgrade DowngradeErrorMessage="A newer version of ZLT is already installed." />
        <MediaTemplate EmbedCab="yes" />

        <!-- Features to install -->
        <Feature 
            Id="ProductFeature" 
            Title="ZLT System Monitor" 
            Level="1">
            <ComponentGroupRef Id="ProductComponents" />
            <ComponentRef Id="ApplicationShortcut" />
            <ComponentRef Id="RegistryEntries" />
        </Feature>

        <!-- Optional autostart feature -->
        <Feature 
            Id="AutoStartFeature" 
            Title="Start on Windows boot" 
            Level="1" 
            Description="Launch ZLT automatically when Windows starts">
            <ComponentRef Id="AutoStartEntry" />
        </Feature>

        <!-- User interface -->
        <UI>
            <UIRef Id="WixUI_FeatureTree" />
            <Publish Dialog="ExitDialog" Control="Finish" Event="DoAction" Value="LaunchApplication">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed</Publish>
        </UI>
        
        <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" />
        <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch ZLT System Monitor" />

        <InstallExecuteSequence>
            <Custom Action="SetTargetDir" Before="InstallValidate"></Custom>
        </InstallExecuteSequence>
    </Product>

    <!-- Directory structure -->
    <Fragment>
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="ProgramFilesFolder">
                <Directory Id="INSTALLFOLDER" Name="ZLT System Monitor" />
            </Directory>
            <Directory Id="ProgramMenuFolder">
                <Directory Id="ApplicationProgramsFolder" Name="ZLT System Monitor" />
            </Directory>
            <Directory Id="StartupFolder" />
        </Directory>
    </Fragment>

    <!-- Components to install -->
    <Fragment>
        <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
            <Component Id="MainExecutable" Guid="*">
                <File Id="ZLTExe" Source="target/release/zlt.exe" KeyPath="yes" />
                
                <!-- Add service installation if needed -->
                <!-- <ServiceInstall Id="ServiceInstaller" Type="ownProcess" Name="ZLTService" DisplayName="ZLT System Monitor Service"
                    Description="System monitoring service" Start="auto" ErrorControl="normal" />
                <ServiceControl Id="StartService" Start="install" Stop="both" Remove="uninstall" Name="ZLTService" Wait="yes" /> -->
            </Component>
            
            <!-- Add any additional files your application needs -->
            <Component Id="ConfigFile" Guid="*">
                <File Id="ConfigJson" Source="config.json" KeyPath="yes" />
            </Component>
            
            <!-- Add any folders that need to be created -->
            <Component Id="DataFolder" Guid="*">
                <CreateFolder Directory="DataFolder" />
                <RemoveFolder Id="RemoveDataFolder" Directory="DataFolder" On="uninstall" />
                <RegistryValue Root="HKCU" Key="Software\ZLT\DataFolder" Type="integer" Value="1" KeyPath="yes" />
            </Component>
        </ComponentGroup>

        <!-- Create Start Menu shortcuts -->
        <Component Id="ApplicationShortcut" Guid="*" Directory="ApplicationProgramsFolder">
            <Shortcut 
                Id="ApplicationStartMenuShortcut" 
                Name="ZLT System Monitor" 
                Description="Launch ZLT System Monitor"
                Target="[INSTALLFOLDER]zlt.exe" 
                WorkingDirectory="INSTALLFOLDER" />
            <Shortcut 
                Id="UninstallShortcut" 
                Name="Uninstall ZLT" 
                Description="Uninstalls ZLT System Monitor"
                Target="[SystemFolder]msiexec.exe" 
                Arguments="/x [ProductCode]" />
            <RemoveFolder Id="CleanUpShortcut" Directory="ApplicationProgramsFolder" On="uninstall" />
            <RegistryValue Root="HKCU" Key="Software\ZLT" Name="installed" Type="integer" Value="1" KeyPath="yes" />
        </Component>

        <!-- Registry entries -->
        <Component Id="RegistryEntries" Guid="*" Directory="INSTALLFOLDER">
            <RegistryKey Root="HKLM" Key="Software\ZLT">
                <RegistryValue Type="string" Name="InstallPath" Value="[INSTALLFOLDER]" KeyPath="yes" />
                <RegistryValue Type="string" Name="Version" Value="1.0.0.0" />
            </RegistryKey>
        </Component>

        <!-- Autostart entry -->
        <Component Id="AutoStartEntry" Guid="*" Directory="StartupFolder">
            <Shortcut 
                Id="AutoStartShortcut" 
                Name="ZLT System Monitor" 
                Description="ZLT System Monitoring Dashboard"
                Target="[INSTALLFOLDER]zlt.exe" 
                WorkingDirectory="INSTALLFOLDER" />
            <RemoveFolder Id="CleanUpAutoStart" Directory="StartupFolder" On="uninstall" />
            <RegistryValue Root="HKCU" Key="Software\ZLT" Name="autostart" Type="integer" Value="1" KeyPath="yes" />
        </Component>
    </Fragment>

    <!-- Custom actions -->
    <Fragment>
        <CustomAction Id="LaunchApplication" 
            FileKey="ZLTExe" 
            ExeCommand="" 
            Return="asyncNoWait" />

        <CustomAction Id="SetTargetDir" 
            Property="TARGETDIR" 
            Value="[INSTALLFOLDER]" />
    </Fragment>
</Wix>
